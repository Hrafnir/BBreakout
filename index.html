<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>BBreakout v1.8 - Separate Audio Controls</title>
<style>
    /* CSS KODE (samme som før, men justert audioControls) */
    body { background: #222; margin: 0; padding: 20px 0; display: flex; justify-content: center; min-height: 100vh; font-family: Arial, sans-serif; color: #fff; overflow: hidden; }
    #gameContainer { position: relative; width: 800px; display: flex; flex-direction: column; align-items: center; }
    canvas { display: block; border: 1px solid #555; }
    .hidden { display: none !important; }
    #startScreen { position: absolute; top: 0; left: 0; width: 800px; height: 600px; background-color: #1a1a1a; background-image: url('image/BBreakout.png'); background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; border: 1px solid #555; box-sizing: border-box; }
    #startScreenContent { display: flex; flex-direction: column; align-items: center; margin-top: 300px; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; }
    #startButton { padding: 15px 30px; font-size: 24px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; box-shadow: 0 4px #999; transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s; }
    #startButton:hover { background-color: #45a049; }
    #startButton:active { background-color: #3e8e41; box-shadow: 0 2px #666; transform: translateY(2px); }
    #versionText { position: absolute; bottom: 15px; right: 15px; font-size: 14px; color: rgba(255, 255, 255, 0.7); }
    #uiContainer { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 8px 15px; background: rgba(0,0,0,0.6); box-sizing: border-box; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; margin-top: -1px; height: 50px; }
    #gameInfo { display: flex; gap: 20px; flex-shrink: 0; } /* Ikke la denne krympe */

    /* Justert layout for flere lydkontroller */
    #audioControlsContainer {
        display: flex;
        gap: 15px; /* Mellomrom mellom musikk- og SFX-kontroller */
        align-items: center;
        flex-wrap: nowrap; /* Unngå wrapping */
    }
    .audioControlGroup {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .audioControlGroup label {
         font-size: 14px;
         margin-right: -3px;
         white-space: nowrap; /* Unngå label wrapping */
    }
    .volumeSlider { /* Felles klasse for slidere */
        width: 70px; /* Litt smalere slider */
        cursor: pointer;
        accent-color: #0095DD;
    }
    .muteButton { /* Felles klasse for mute-knapper */
        padding: 5px 8px; /* Litt mindre padding */
        font-size: 12px;
        cursor: pointer;
        background-color: #0077AA;
        color: white;
        border: none;
        border-radius: 3px;
        min-width: 55px; /* Litt smalere knapp */
        text-align: center;
    }
    .muteButton:hover { background-color: #005588; }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="startScreen">
         <div id="startScreenContent"> <button id="startButton">Start Spillet</button> </div>
        <div id="versionText">Versjon 1.8</div>
    </div>
    <canvas id="gameCanvas" width="800" height="600" class="hidden"></canvas>
    <div id="uiContainer" class="hidden">
        <div id="gameInfo"> <span id="score">Poeng: 0</span> <span id="lives">Liv: 3</span> <span id="level">Nivå: 1</span> </div>

        <div id="audioControlsContainer">
            <div class="audioControlGroup">
                 <label for="musicVolumeSlider">Musikk:</label>
                 <input type="range" id="musicVolumeSlider" class="volumeSlider" min="0" max="100" value="20">
                 <button id="musicMuteButton" class="muteButton">Mute</button>
            </div>
            <div class="audioControlGroup">
                <label for="sfxVolumeSlider">Effekter:</label>
                <input type="range" id="sfxVolumeSlider" class="volumeSlider" min="0" max="100" value="30"> <button id="sfxMuteButton" class="muteButton">Mute</button>
            </div>
        </div>

    </div>
</div>

<audio id="backgroundMusic" loop preload="auto"> <source src="audio/BBreakout.mp3" type="audio/mpeg">...</audio>
<audio id="hitSound" preload="auto"> <source src="audio/hit.wav" type="audio/wav">...</audio>
<audio id="paddleSound" preload="auto"> <source src="audio/paddle.wav" type="audio/wav">...</audio>
<audio id="wallSound" preload="auto"> <source src="audio/wall.wav" type="audio/wav">...</audio>

<script>
    // --- DOM Element References ---
    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score'); const livesElement = document.getElementById('lives'); const levelElement = document.getElementById('level');
    const startScreen = document.getElementById('startScreen'); const startButton = document.getElementById('startButton');
    const uiContainer = document.getElementById('uiContainer'); const versionText = document.getElementById('versionText');

    // Musikk Kontroller
    const musicVolumeSlider = document.getElementById('musicVolumeSlider');
    const musicMuteButton = document.getElementById('musicMuteButton');

    // SFX Kontroller
    const sfxVolumeSlider = document.getElementById('sfxVolumeSlider');
    const sfxMuteButton = document.getElementById('sfxMuteButton');

    // Audio Elements
    const backgroundMusic = document.getElementById('backgroundMusic');
    const hitSound = document.getElementById('hitSound');
    const paddleSound = document.getElementById('paddleSound');
    const wallSound = document.getElementById('wallSound');

    // Separate arrays for control
    const backgroundMusicArray = [backgroundMusic];
    const sfxSoundArray = [hitSound, paddleSound, wallSound];

    // --- Spillkonstanter og Variabler ---
    const VERSION = "1.8";
    const CANVAS_WIDTH = canvas.width; const CANVAS_HEIGHT = canvas.height;
    // ... (resten av spillkonstantene uendret) ...
    const INITIAL_MUSIC_VOLUME = 0.2; // Startvolum for musikk
    const INITIAL_SFX_VOLUME = 0.3;   // Startvolum for SFX (50% høyere enn 0.2)

    // Spillstatus (uendret)
    let paddleWidth = PADDLE_BASE_WIDTH; let paddleX = (CANVAS_WIDTH - paddleWidth) / 2; let paddleLastX = paddleX; let paddleVelX = 0;
    let rightPressed = false; let leftPressed = false;
    let balls = []; let bricks = []; let particles = []; let powerups = [];
    let score = 0; let lives = 3; let currentLevel = 1;
    let gameRunning = false; let gamePaused = false; let bricksRemaining = 0;
    let activePowerups = { largerPaddle: null, slowBall: null }; let animationFrameId = null;

    // Lydstatus
    let isMusicMuted = false; let lastMusicVolume = INITIAL_MUSIC_VOLUME;
    let isSfxMuted = false; let lastSfxVolume = INITIAL_SFX_VOLUME;

    const PowerupType = { /* ... */ }; const LEVELS = [ /* ... */ ];
    const BRICK_HEALTH_COLORS = { /* ... */ }; const BRICK_DEFAULT_COLOR = "#DAF7A6";
    // ... (resten av fargekonstanter etc. uendret) ...

    // --- Lydkontroll Funksjoner (Oppdatert/Nye) ---

    // Spiller av KUN lydeffekter, respekterer SFX mute
    function playSound(soundElement) {
        if (!soundElement || typeof soundElement.play !== 'function') { return; }
        // *** Sjekker nå isSfxMuted ***
        if (isSfxMuted) return;
        try {
            soundElement.currentTime = 0;
            const playPromise = soundElement.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => { if (error.name !== 'NotAllowedError' && error.name !== 'AbortError') { console.error(`Audio play failed:`, error); } });
            }
        } catch (e) { console.error(`Error trying to play sound:`, e); }
    }

    // Setter volum KUN for musikk
    function setMusicVolume(volume) {
        lastMusicVolume = volume;
        backgroundMusicArray.forEach(sound => {
            if (sound) { try { sound.volume = volume; } catch (e) { /*...*/ } }
        });
    }

    // Setter volum KUN for SFX
    function setSfxVolume(volume) {
        lastSfxVolume = volume;
        sfxSoundArray.forEach(sound => {
            if (sound) { try { sound.volume = volume; } catch (e) { /*...*/ } }
        });
    }

    // Muter/Unmuter KUN musikk
    function toggleMusicMute() {
        isMusicMuted = !isMusicMuted;
        if (isMusicMuted) {
            backgroundMusicArray.forEach(sound => { if (sound) sound.volume = 0; });
            musicMuteButton.textContent = "Unmute";
        } else {
            setMusicVolume(lastMusicVolume); // Gjenopprett volum
            musicVolumeSlider.value = lastMusicVolume * 100;
            musicMuteButton.textContent = "Mute";
        }
    }

    // Muter/Unmuter KUN SFX
    function toggleSfxMute() {
        isSfxMuted = !isSfxMuted;
        if (isSfxMuted) {
            sfxSoundArray.forEach(sound => { if (sound) sound.volume = 0; });
            sfxMuteButton.textContent = "Unmute";
        } else {
            setSfxVolume(lastSfxVolume); // Gjenopprett volum
            sfxVolumeSlider.value = lastSfxVolume * 100;
            sfxMuteButton.textContent = "Mute";
        }
    }

    // Oppdatert for å håndtere begge kontrollsettene
    function setupAudioControls() {
        console.log("Setting up audio controls (Music & SFX)...");
        try {
            // --- Musikk Initialisering ---
            setMusicVolume(INITIAL_MUSIC_VOLUME);
            musicVolumeSlider.value = INITIAL_MUSIC_VOLUME * 100;
            lastMusicVolume = INITIAL_MUSIC_VOLUME;
            isMusicMuted = false;
            musicMuteButton.textContent = "Mute";

            // --- SFX Initialisering ---
            setSfxVolume(INITIAL_SFX_VOLUME);
            sfxVolumeSlider.value = INITIAL_SFX_VOLUME * 100;
            lastSfxVolume = INITIAL_SFX_VOLUME;
            isSfxMuted = false;
            sfxMuteButton.textContent = "Mute";

            // --- Fjern gamle listeners (for sikkerhets skyld) ---
            musicVolumeSlider.oninput = null; musicMuteButton.onclick = null;
            sfxVolumeSlider.oninput = null; sfxMuteButton.onclick = null;

            // --- Musikk Listeners ---
            musicVolumeSlider.oninput = (e) => {
                const newVolume = e.target.value / 100;
                setMusicVolume(newVolume);
                if (newVolume > 0 && isMusicMuted) { isMusicMuted = false; musicMuteButton.textContent = "Mute"; }
                else if (newVolume === 0 && !isMusicMuted) { isMusicMuted = true; musicMuteButton.textContent = "Unmute"; }
            };
            musicMuteButton.onclick = toggleMusicMute;

            // --- SFX Listeners ---
            sfxVolumeSlider.oninput = (e) => {
                const newVolume = e.target.value / 100;
                setSfxVolume(newVolume);
                if (newVolume > 0 && isSfxMuted) { isSfxMuted = false; sfxMuteButton.textContent = "Mute"; }
                else if (newVolume === 0 && !isSfxMuted) { isSfxMuted = true; sfxMuteButton.textContent = "Unmute"; }
            };
            sfxMuteButton.onclick = toggleSfxMute;

            console.log("Audio controls setup complete.");

        } catch (error) {
             console.error("Error setting up audio controls:", error);
        }
    }

    // --- Start Spillet Funksjon (uendret) ---
    function startGame() { console.log("--- startGame called ---"); startScreen.classList.add('hidden'); canvas.classList.remove('hidden'); uiContainer.classList.remove('hidden'); console.log("Setting up audio controls..."); setupAudioControls(); console.log("Attempting to play background music..."); playSound(backgroundMusic); console.log("Resetting game state..."); score = 0; lives = 3; currentLevel = 1; gamePaused = false; gameRunning = true; console.log("Initializing level 1..."); initializeLevel(currentLevel); console.log("Checking animationFrameId before starting loop:", animationFrameId); if (!animationFrameId) { console.log("Starting game loop..."); gameLoop(); } else { console.warn("startGame: gameLoop seems to be already running? ID:", animationFrameId); cancelAnimationFrame(animationFrameId); animationFrameId = null; console.log("Restarting game loop forcefully."); gameLoop(); } console.log("--- startGame finished ---"); }
    startButton.addEventListener('click', startGame);
    versionText.textContent = `Versjon ${VERSION}`;

    // --- Initialisering (uendret) ---
    function initializeLevel(level) { /* ... */ }
    function createBall(x, y, dx, dy) { /* ... */ }
    function initializeBricks() { /* ... (med fix fra v1.6) ... */ }

    // --- Input Handlers (uendret) ---
    document.addEventListener("keydown", keyDownHandler, false); /* ... */ function keyUpHandler(e) { /* ... */ } function mouseMoveHandler(e) { /* ... */ }

    // --- Collision Detection (uendret) ---
    function collisionDetection() { /* ... (kaller playSound(hitSound)) ... */ }

    // --- Resten av spillogikk (uendret) ---
    function createPowerup(x, y) { /* ... */ } function activatePowerup(type) { /* ... */ } function createParticles(x, y, color) { /* ... */ } function updateParticles() { /* ... */ }

    // --- Tegnefunksjoner (uendret) ---
    function drawBackground() { /* ... */ } function drawPaddle() { /* ... */ } function drawBalls() { /* ... */ } function drawBricks() { /* ... */ } function drawParticles() { /* ... */ } function drawPowerups() { /* ... */ }
    function lightenColor(hex, percent) { /* ... (med fix fra v1.6) ... */ } function darkenColor(hex, percent) { /* ... */ }

    // --- Bevegelsesfunksjoner (uendret, kaller playSound for vegg/paddle) ---
    function movePaddle() { /* ... */ }
    function moveBalls() { /* ... (kaller playSound(wallSound) og playSound(paddleSound)) ... */ }
    function movePowerups() { /* ... */ }
    function updateUI() { /* ... */ }

    // --- Game State Functions (uendret) ---
    function levelComplete() { /* ... */ } function gameOver() { /* ... */ } function victory() { /* ... */ }

    // --- Hoved Spill-Loop (uendret) ---
    function gameLoop() { /* ... */ }

    // --- Initial Setup ---
    console.log(`BBreakout ${VERSION} Script loaded. Waiting for start button click.`);
    // Viktig: Kjør setup FØR start, men IKKE spill musikk ennå
    setupAudioControls();

</script>

</body>
</html>
